---
title: "SQLDelight ã§ upsert ã™ã‚‹"
emoji: "ğŸ•"
type: "tech"
topics:
  - "android"
  - "kotlin"
  - "kmm"
  - "sqldelight"
published: true
published_at: "2022-11-25 16:34"
---

SQLDelight ã¯ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œã‚’æ¥½ã«ã—ã¦ãã‚Œã‚‹ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã§ã™ã€‚
CashApp ( Square ç¤¾ ) ãŒé–‹ç™ºã—ã¦ãŠã‚Šã€KMM ã‚’åˆ©ç”¨ã—ãŸãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚å°å…¥ã§ãã‚‹ã®ãŒåˆ©ç‚¹ã ã¨æ€ã„ã¾ã™ã€‚

https://cashapp.github.io/sqldelight/

ä»Šå¹´ ( 2022å¹´ ) ã® DroidKaigi ã§ã‚‚æ¡ç”¨ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚

https://github.com/DroidKaigi/conference-app-2022/blob/c93babf6788fc828f9d5a988cd5c9697fe144275/gradle/libs.versions.toml#L132-L135

## Upsert ãŒã—ãŸã„

Room ã§ã¯ Upsert ã®æ©Ÿèƒ½ãŒæä¾›ã•ã‚Œã¦ã„ã¾ã™ã€‚
åŒæ§˜ã®å‹•ä½œã‚’ SQLDelight ã§å®Ÿç¾ã—ãŸã„ã§ã™ã€‚

https://developer.android.com/reference/kotlin/androidx/room/Upsert

## å…ˆã«çµè«–

ã“ã‚“ãªæ„Ÿã˜ã§è¨˜è¼‰ã™ã‚‹ã¨ã†ã¾ãå‹•ä½œã—ã¾ã™ã€‚

```sql:HogeTable.sq
upsert {
    UPDATE hogeTable
    SET param1 = :param1,
        param2 = :param2,
        param3 = :param3
    WHERE id = :id;
  
    INSERT OR IGNORE INTO hogeTable (
        id,
        param1,
        param2,
        param3
    ) VALUES (
        :id,
        :param1,
        :param2,
        :param3
    );
  }
```

## Grouping Statements ã‚’åˆ©ç”¨ã™ã‚‹

å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã—ã£ã‹ã‚Šã¨ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¨ã—ã¦è¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã—ãŸã€‚
`Grouping Statements` ã¨ã„ã†æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚Œã°å®Ÿç¾ã§ããã†ã§ã™ã€‚

https://cashapp.github.io/sqldelight/android_sqlite/grouping_statements/

### INSERT æ–‡ã§ ç–‘å•ç¬¦ ( qmark ã‚¹ã‚¿ã‚¤ãƒ«) ã‚’ä½¿ç”¨ã—ã¦ã„ãŸå ´åˆã¯æ³¨æ„ãŒå¿…è¦

ã‚‚ã¨ã‚‚ã¨ã“ã‚“ãªæ„Ÿã˜ã® `INSERT` æ–‡ã‚’åˆ©ç”¨ã—ã¦ã„ãŸã®ã§ã€ã“ã‚Œã‚’æµç”¨ã—ã‚ˆã†ã¨ã—ã¾ã—ãŸã€‚

```sql:HogeTable.sq
insert:
INSERT OR IGNORE INTO hogeTable (
  id,
  param1,
  param2,
  param3
) VALUES ?;
```

æµç”¨ã—ã¦è¨˜è¼‰ã—ãŸã‚‚ã®ãŒã“ã¡ã‚‰ã€‚
`INSERT` æ–‡ã§ qmark ã‚¹ã‚¿ã‚¤ãƒ«ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚

```sql:HogeTable.sq
upsert {
    UPDATE hogeTable
    SET param1 = :param1,
        param2 = :param2,
        param3 = :param3
    WHERE id = :id;
  
    INSERT OR IGNORE INTO hogeTable (
        id,
        param1,
        param2,
        param3
    ) VALUES ?;
  }
```

ã™ã‚‹ã¨ã€ã“ã‚“ãªã‚¨ãƒ©ãƒ¼ãŒâ€¦ã€‚

```log
FAILURE: Build failed with an exception.

* What went wrong:
Execution failed for task ':core:database:generateCommonMainDatabaseInterface'.
> A failure occurred while executing com.squareup.sqldelight.gradle.SqlDelightTask$GenerateInterfaces
   > Failed to compile SqlDelightStmtClojureStmtListImpl(STMT_CLOJURE_STMT_LIST): [] :
     UPDATE hogeTable
       SET param1 = :param1,
           param2 = :param2,
           param3 = :param3
       WHERE id = :id;
     
       INSERT OR IGNORE INTO hogeTable (
           id,
           param1,
           param2,
           param3
       ) VALUES ?;
```

ã¬ã¬ã€ã‚ˆãã‚ã‹ã‚‰ã‚“â€¦ã€‚
ãŠã‹ã—ã„ã¨ã“ã‚ã¯ãªã•ãã†ã ã£ãŸã®ã§ã™ãŒã€å…¬å¼ãŒ named ã‚¹ã‚¿ã‚¤ãƒ«ã§è¨˜è¼‰ã—ã¦ã‚ã‚‹ãªã¨æ€ã„ã€æ›¸ãç›´ã—ã¦ã¿ã¾ã—ãŸã€‚

```sql:HogeTable.sq
upsert {
    UPDATE hogeTable
    SET param1 = :param1,
        param2 = :param2,
        param3 = :param3
    WHERE id = :id;
  
    INSERT OR IGNORE INTO hogeTable (
        id,
        param1,
        param2,
        param3
    ) VALUES (
        :id,
        :param1,
        :param2,
        :param3
    );
  }
```

ã“ã‚Œã§ãƒ“ãƒ«ãƒ‰ãŒé€šã‚Šã€ç„¡äº‹ Kotlin ãƒ•ã‚¡ã‚¤ãƒ«ãŒç”Ÿæˆã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã§ãã¾ã—ãŸ ğŸ‰