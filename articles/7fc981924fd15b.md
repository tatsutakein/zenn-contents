---
title: "GitHub App ã§ Dependabot ã®è‡ªå‹• Approve & ãƒãƒ¼ã‚¸ã‚’è¡Œã†"
emoji: "ğŸ‘"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [ "github", "githubactions", "dependabot" ]
published: true
---

## ã¯ã˜ã‚ã«

ã“ã‚“ã«ã¡ã¯ã€ãŸã£ã¤ãƒ¼ ( [@tatsutakein][Twitter] ) ã§ã™ã€‚

[Dependabot] ã‚’åˆ©ç”¨ã—ãŸä¾å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®è‡ªå‹•ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã€ä¾¿åˆ©ã§ã™ã‚ˆã­ã€‚
2023å¹´8æœˆã«ã¯ [ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°æ©Ÿèƒ½ãŒè¿½åŠ ][grouped-version-updates-for-dependabot-are-generally-available] ã•ã‚Œã€éå¸¸ã«ä½¿ã„å‹æ‰‹ãŒè‰¯ããªã‚Šã¾ã—ãŸã€‚

ãã‚“ãª Dependabot ã§ã™ãŒã€ãƒã‚¤ãƒŠãƒ¼ã‚„ãƒ‘ãƒƒãƒã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’éƒ½åº¦ Approve & ãƒãƒ¼ã‚¸ã™ã‚‹ã®ã¯é¢å€’ã§ã™ã€‚
å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ã¯ [Pull Requestã®æ‰¿èª][approve-a-pull-request] ã‚„ [Pull Requestã®è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹][enable-auto-merge-on-a-pull-request] æ–¹æ³•ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã¾ã™ãŒã€PAT ã‚’ã‚ã¾ã‚Šä½¿ç”¨ã—ãŸããªã„ã¨ã„ã†ã‚±ãƒ¼ã‚¹ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã€‚
ãã“ã§ [GitHub Apps] ã‚’åˆ©ç”¨ã—ãŸã„ã¨ã“ã‚ã§ã™ãŒã€ãã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦ã¯ç‰¹ã«æ˜è¨˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
ãã®ãŸã‚ã€ä»Šå›ã¯ GitHub Apps ã‚’åˆ©ç”¨ã—ã¦ Dependabot ã®è‡ªå‹• Approve & ãƒãƒ¼ã‚¸ã‚’è¡Œã†æ‰‹é †ã«ã¤ã„ã¦è¨˜è¼‰ã—ã¦ã¿ã¾ã™ã€‚

## ã‚´ãƒ¼ãƒ«

ä»¥ä¸‹ã®è¨­å®šã® GitHub ãƒªãƒã‚¸ãƒˆãƒªã§å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚

- General
  - [x] Allow auto-merge
- Actions permissions
  - Workflow permissions
    - Read and write permissions
    - [x] Allow GitHub Actions to create and approve pull requests
- Branch protection rule
  - [x] Require a pull request before merging
    - [x] Require review from Code Owners
  - [x] Require status checks to pass before merging
    - Status checks that are required.
      - check-frontend ãªã©ã®æ¤œè¨¼ç”¨ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
  - [x] Restrict who can push to matching branches

## å†…å®¹

å¤§ãã 2 ã¤ã®æ‰‹é †ãŒã‚ã‚Šã¾ã™ã€‚

### Create GitHub App Token ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã§ãã‚‹çŠ¶æ…‹ã«ã™ã‚‹

[Create GitHub App Token] ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®æ‰‹é †ã§ã™ã€‚

#### GitHub App ã®ä½œæˆ

ã“ã¡ã‚‰ã«ã¤ã„ã¦ã¯ [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][registering-a-github-app] ã‚’å‚ç…§ã—ã¦ä½œæˆã™ã‚‹ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

æ¨©é™ã¯ [Pull Requestã®æ‰¿èª][approve-a-pull-request] ã¨ [Pull Requestã®è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹][enable-auto-merge-on-a-pull-request] ã§å¿…è¦ãªä»¥ä¸‹ã®é …ç›®ã‚’è¨­å®šã—ã¾ã™ã€‚

- Contents ... Access: Read and write
- Pull Requests ... Access: Read and write

#### ä½œæˆã—ãŸ GitHub App ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

ã“ã¡ã‚‰ã‚‚ [å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][installing-your-own-github-app] ã‚’å‚ç…§ã—ã¦é€²ã‚ã‚‹ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚

#### ãƒªãƒã‚¸ãƒˆãƒª ( ã¾ãŸã¯ Organization ) ã® variables, secrets ã‚’è¨­å®šã™ã‚‹

##### App ID

ä½œæˆã—ãŸ GitHub App ã®è¨­å®šç”»é¢ã‹ã‚‰ä»¥ä¸‹ã®ç”»åƒã®éƒ¨åˆ†ã®å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚

![App ID](/images/7fc981924fd15b/github-app-id.webp)

ãƒªãƒã‚¸ãƒˆãƒªã®è¨­å®šç”»é¢ã‹ã‚‰ Security ã‚«ãƒ†ã‚´ãƒªå†…ã® Secrets and variables > Actions ã‹ã‚‰ Variables ã‚’è¿½åŠ ã—ã¾ã™ã€‚

:::message
ä»¥ä¸‹ã®ç”»åƒã¯ Organization å´ã§è¨­å®šã—ã¦ã„ã‚‹ãŸã‚å°‘ã—ç•°ãªã‚Šã¾ã™ãŒã€è¨­å®šå†…å®¹ã¯åŒã˜ã§ã™
:::

![Actions variables](/images/7fc981924fd15b/actions-variables.webp)

##### Private key

ä½œæˆã—ãŸ GitHub App ã®è¨­å®šç”»é¢ã‹ã‚‰ä»¥ä¸‹ã®ç”»åƒã®éƒ¨åˆ†ã®å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚

![Private key](/images/7fc981924fd15b/private-key.webp)

ãƒªãƒã‚¸ãƒˆãƒªã®è¨­å®šç”»é¢ã‹ã‚‰ Security ã‚«ãƒ†ã‚´ãƒªå†…ã® Secrets and variables > Dependabot ã‹ã‚‰ Secrets ã‚’è¿½åŠ ã—ã¾ã™ã€‚

:::message
ã¾ãŸã‚‚ã‚„ä»¥ä¸‹ã®ç”»åƒã¯ Organization å´ã§è¨­å®šã—ã¦ã„ã‚‹ãŸã‚å°‘ã—ç•°ãªã‚Šã¾ã™ãŒã€è¨­å®šå†…å®¹ã¯åŒã˜ã§ã™
:::

![Dependabot secrets](/images/7fc981924fd15b/dependabot-secrets.webp)

### Dependabot ã®è‡ªå‹• Approve & ãƒãƒ¼ã‚¸

GitHub App ã®ä½œæˆãŒã§ããŸã‚‰ã„ã‚ˆã„ã‚ˆè‡ªå‹• Approve & ãƒãƒ¼ã‚¸ã®è¨­å®šã‚’ã—ã¾ã™ã€‚

#### ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®è¿½åŠ 

[å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ][automating-dependabot-with-github-actions] ã«æ²¿ã„ã¤ã¤ [Create GitHub App Token] ã‚’åˆ©ç”¨ã—ãŸå½¢ã«å¤‰æ›´ã—ã¾ã™ã€‚
if ã®æ¡ä»¶ãŒãƒã‚¤ãƒŠãƒ¼ã€ãƒ‘ãƒƒãƒã¨ãªã£ã¦ã„ã¾ã™ã®ã§ã€é©å®œå¤‰æ›´ã—ã¦ãŠä½¿ã„ãã ã•ã„ ğŸ™Œ

```yaml:dependabot-auto-merge.yml
name: "Dependabot auto-merge"
on: pull_request

jobs:
  dependabot:
    runs-on: ubuntu-22.04
    if: github.actor == 'dependabot[bot]'
    steps:
      # https://github.com/marketplace/actions/create-github-app-token
      - name: Create GitHub App Token
        uses: actions/create-github-app-token@v1.6.2
        id: app-token
        with:
          app-id: ${{ vars.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_PRIVATE_KEY }}

      # https://github.com/marketplace/actions/fetch-metadata-from-dependabot-prs
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v1.6.0
        with:
          github-token: "${{ steps.app-token.outputs.token }}"

      - name: Enable auto-merge for Dependabot PRs
        if: |
          steps.metadata.outputs.update-type == 'version-update:semver-patch' ||
          steps.metadata.outputs.update-type == 'version-update:semver-minor'
        run: |
          gh pr review --approve "$PR_URL"
          gh pr merge --auto --merge "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
```

#### GitHub ãƒªãƒã‚¸ãƒˆãƒªå´ã®è¨­å®šã‚’è¿½åŠ 

ç¾çŠ¶ã®ã¾ã¾å‹•ã‹ã™ã¨ `Pull request User is not authorized for this protected branch (enablePullRequestAutoMerge)` ã¨è¨€ã‚ã‚Œã¦ã—ã¾ã„ã€æ‚²ã—ã„æ€ã„ã‚’ã—ã¾ã™ã€‚

![Pull request User is not authorized for this protected branch](/images/7fc981924fd15b/not-authorized.webp)

ãã®ãŸã‚ã€è¿½åŠ ã—ãŸ GitHub App ã‚’ Branch protection rule ã® `Restrict who can push to matching branches` ã®å¯¾è±¡ã«è¿½åŠ ã—ã¾ã™ã€‚

![Dependabot secrets](/images/7fc981924fd15b/push-access.webp)

#### ã‚³ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒŠé–¢é€£ã®è¨­å®š

ç¾çŠ¶ã®ã¾ã¾å‹•ã‹ã™ã¨ Approve & è‡ªå‹•ãƒãƒ¼ã‚¸çŠ¶æ…‹ã«ã¯ãªã£ã¦ã„ã‚‹ã‚‚ã®ã®ã€GitHub App ãŒã‚³ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒŠã§ã¯ãªã„ãŸã‚ãƒãƒ¼ã‚¸ã•ã‚Œãªã„çŠ¶æ…‹ã«ãªã£ã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚
ãã®ãŸã‚ CODEOWNERS ã« ä½œæˆã—ãŸ GitHub App ã‚’è¿½åŠ ã—ã¦ã‚ã’ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

:::message
é›‘ã«ã™ã¹ã¦ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¯¾è±¡ã¨ã—ã¦ã—ã¾ã£ã¦ã„ã¾ã™ãŒã€å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµã‚‹ã®ãŒè‰¯ã„ã¨æ€ã„ã¾ã™ã€‚
:::

```text:.github/CODEOWNERS
* @tatsutakein @nito-bot[bot]
```

## ãŠã‚ã‚Šã«

ä»¥ä¸Šã§ GitHub App ãŒ Dependabot ã®è‡ªå‹•ãƒãƒ¼ã‚¸ã‚’ã—ã¦ãã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸ ğŸ‰

å°‘ãªã„ãƒªãƒã‚¸ãƒˆãƒªã§ã‚ã‚Œã°å°‘ã—ã®æ‰‹é–“ã§æ¸ˆã‚€ã‚‚ã®ã®ã€è¤‡æ•°ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ä¸¦è¡Œã§è¦‹ã¦ã„ã‚‹ã¨åœ°å‘³ã«æ™‚é–“ã¨æ‰‹é–“ãŒå–ã‚‰ã‚Œã¦ã—ã¾ã†ãŸã‚è‡ªå‹•åŒ–ã§ãã¦ã‚ˆã‹ã£ãŸã§ã™ã€‚

ã‚‚ã—ã‚ˆã‚Šè‰¯ã„ã‚„ã‚Šæ–¹ã‚’ã”å­˜ã˜ã®æ–¹ãŒã„ãŸã‚‰ãœã²æ•™ãˆã¦ã„ãŸã ã‘ã‚‹ã¨å¹¸ã„ã§ã™ ğŸ€

## å‚è€ƒãƒªãƒ³ã‚¯

- [Keeping your supply chain secure with Dependabot][Dependabot]
- [Grouped version updates for Dependabot are generally available][grouped-version-updates-for-dependabot-are-generally-available]
- [Automating Dependabot with GitHub Actions][automating-dependabot-with-github-actions]
- [GitHub Apps documentation][GitHub Apps]
- [Create GitHub App Token Â· Actions Â· GitHub Marketplace][Create GitHub App Token]
- [Registering a GitHub App][registering-a-github-app]
- [Installing your own GitHub App][installing-your-own-github-app]

<!-- Links -->

[Twitter]: https://twitter.com/tatsutakein

[Dependabot]: https://docs.github.com/code-security/dependabot
[grouped-version-updates-for-dependabot-are-generally-available]: https://github.blog/changelog/2023-08-24-grouped-version-updates-for-dependabot-are-generally-available/
[approve-a-pull-request]: https://docs.github.com/code-security/dependabot/working-with-dependabot/automating-dependabot-with-github-actions#approve-a-pull-request
[enable-auto-merge-on-a-pull-request]: https://docs.github.com/code-security/dependabot/working-with-dependabot/automating-dependabot-with-github-actions#enable-auto-merge-on-a-pull-request
[GitHub Apps]: https://docs.github.com/apps

[Create GitHub App Token]: https://github.com/marketplace/actions/create-github-app-token
[registering-a-github-app]: https://docs.github.com/apps/creating-github-apps/registering-a-github-app/registering-a-github-app
[installing-your-own-github-app]: https://docs.github.com/apps/using-github-apps/installing-your-own-github-app

[automating-dependabot-with-github-actions]: https://docs.github.com/code-security/dependabot/working-with-dependabot/automating-dependabot-with-github-actions
